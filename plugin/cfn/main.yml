---
AWSTemplateFormatVersion: "2010-09-09"

Description: >
  CloudFormation template for setting up client plugin for hash matching function and related resources (IAM roles and policies, etc.).

#Metadata:
#  template metadata

Parameters:
  pThornInstanceSubnet:
    Type: AWS::EC2::Subnet::Id
  pThornKeyPair:
    Type: AWS::EC2::KeyPair::KeyName
  pThornAMI:
    Type: AWS::EC2::Image::Id
  pThornNameTag:
    Type: String    
  pThornInstanceType:
    Type: String
    Default: t2.micro
    AllowedValues: 
      - t2.micro
      - m3.medium
      - m4.large
    Description: Enter t2.micro, m3.medium, or m4.large. Default is t2.micro.

#Mappings:
#  set of mappings
#
#Conditions:
#  set of conditions
#
#Transform:
#  set of transforms

Resources:
  iam:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.amazonaws.com/2017thorn7-bm/cfn/iam.yml
      TimeoutInMinutes: '60'
  ec2:
    Type: AWS::CloudFormation::Stack
    DependsOn: iam
    Properties:
      TemplateURL: https://s3.amazonaws.com/2017thorn7-bm/cfn/ec2.yml
      TimeoutInMinutes: '60'
      Parameters:
        pThornInstanceProfile:
          !GetAtt
          - iam
          - Outputs.rThornInstanceProfile
        pThornInstanceSubnet: !Ref pThornInstanceSubnet
        pThornKeyPair: !Ref pThornKeyPair
        pThornAMI: !Ref pThornAMI
        pThornNameTag: !Ref pThornNameTag
        pThornInstanceType: !Ref pThornInstanceType
  sqs:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.amazonaws.com/2017thorn7-bm/cfn/sqs.yml
      TimeoutInMinutes: '60'
  s3:
    Type: AWS::CloudFormation::Stack
    DependsOn: sqs
    Properties:
      TemplateURL: https://s3.amazonaws.com/2017thorn7-bm/cfn/s3.yml
      TimeoutInMinutes: '60'
      Parameters:
        pThornSnsTopic:
          !GetAtt
          - sqs
          - Outputs.rThornSnsTopic
